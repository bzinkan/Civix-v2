// Civix Database Schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Jurisdictions (cities, counties, municipalities)
model Jurisdiction {
  id          String   @id @default(cuid())
  name        String
  type        String   // city, county, state
  state       String
  county      String?
  rulesets    Ruleset[]
  decisions   Decision[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([name, state, county])
  @@index([state])
}

// Rule categories (zoning, animals, business, etc.)
model Ruleset {
  id              String        @id @default(cuid())
  jurisdiction    Jurisdiction  @relation(fields: [jurisdictionId], references: [id], onDelete: Cascade)
  jurisdictionId  String
  category        String        // animals, zoning, business, construction
  version         Int           @default(1)
  isActive        Boolean       @default(true)
  rules           Rule[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([jurisdictionId, category, version])
  @@index([category])
  @@index([jurisdictionId])
}

// Individual rules with conditions
model Rule {
  id                  String    @id @default(cuid())
  ruleset             Ruleset   @relation(fields: [rulesetId], references: [id], onDelete: Cascade)
  rulesetId           String
  key                 String    // stable identifier (e.g., "pitbull_ownership")
  description         String
  outcome             String    // ALLOWED, RESTRICTED, PROHIBITED, CONDITIONAL
  conditions          Json      // structured conditions logic
  citation            String?   // legal reference
  priority            Int       @default(0)

  // AI Matching fields
  subcategory         String?   // e.g., "fences", "chickens", "dangerous_dogs"
  canonicalQuestions  String[]  // Natural language questions this rule answers
  keywords            String[]  // Search keywords for matching
  requiredInputs      String[]  // Fields needed to evaluate this rule

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  citations           Citation[]

  @@unique([rulesetId, key])
  @@index([key])
  @@index([subcategory])
}

// User decisions (free tier)
model Decision {
  id              String        @id @default(cuid())
  jurisdiction    Jurisdiction  @relation(fields: [jurisdictionId], references: [id])
  jurisdictionId  String
  category        String        // animals, zoning, etc.
  questionKey     String        // stable question identifier
  inputs          Json          // user-provided data
  outcome         String        // ALLOWED, RESTRICTED, PROHIBITED, CONDITIONAL
  rationale       String        // explanation
  matchedRules    Json          // rules that matched
  createdAt       DateTime      @default(now())
  user            User?         @relation(fields: [userId], references: [id])
  userId          String?

  @@index([jurisdictionId])
  @@index([category])
  @@index([userId])
}

// Compliance reports (paid tier)
model Report {
  id              String    @id @default(cuid())
  user            User      @relation(fields: [userId], references: [id])
  userId          String
  decisionId      String?   // optional link to decision
  category        String
  jurisdiction    String
  steps           Json      // compliance steps
  forms           Json      // required forms
  providers       Json?     // recommended service providers
  price           Int       // in cents
  stripePiId      String?   // Stripe Payment Intent ID
  status          String    @default("pending") // pending, paid, delivered
  createdAt       DateTime  @default(now())
  deliveredAt     DateTime?

  @@index([userId])
  @@index([status])
}

// Users
model User {
  id                    String         @id @default(cuid())
  email                 String         @unique
  name                  String?
  passwordHash          String
  stripeId              String?        // Stripe customer ID

  // Subscription tracking
  subscriptionStatus    String         @default("none") // none, active, cancelled, past_due
  subscriptionId        String?
  subscriptionEndsAt    DateTime?

  // One-time purchase credits
  queryCredits          Int            @default(0)

  decisions             Decision[]
  reports               Report[]
  conversations         Conversation[]
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  @@index([email])
  @@index([subscriptionStatus])
}

// Anonymous user tracking (for free tier limits)
model AnonymousUsage {
  id            String    @id @default(cuid())
  fingerprint   String    @unique
  queryCount    Int       @default(0)
  lastQueryAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([fingerprint])
  @@index([lastQueryAt])
}

// Conversation sessions (multi-turn AI conversations)
model Conversation {
  id              String    @id @default(cuid())
  user            User?     @relation(fields: [userId], references: [id])
  userId          String?
  fingerprint     String?   // For anonymous users

  // Conversation state
  jurisdiction    String?
  category        String?
  subcategory     String?
  collectedInputs Json      @default("{}")

  // AI provider tracking
  primaryProvider String    @default("gemini") // gemini, anthropic, openai
  fallbackUsed    Boolean   @default(false)

  // Status
  status          String    @default("active") // active, completed, abandoned

  messages        Message[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  completedAt     DateTime?

  @@index([userId])
  @@index([fingerprint])
  @@index([status])
}

// Individual messages in a conversation
model Message {
  id              String        @id @default(cuid())
  conversation    Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId  String

  role            String        // user, assistant, system
  content         String        @db.Text

  // AI metadata
  provider        String?       // Which AI generated this (if assistant)
  tokensUsed      Int?
  confidence      Float?        // For AI responses

  createdAt       DateTime      @default(now())

  @@index([conversationId])
  @@index([createdAt])
}

// Citations for legal references
model Citation {
  id              String   @id @default(cuid())
  rule            Rule     @relation(fields: [ruleId], references: [id], onDelete: Cascade)
  ruleId          String

  ordinanceNumber String
  section         String
  title           String?
  text            String   @db.Text
  url             String?
  pageNumber      Int?

  createdAt       DateTime @default(now())

  @@index([ruleId])
}

// Admin audit log
model AuditLog {
  id          String    @id @default(cuid())
  action      String    // rule_created, rule_updated, jurisdiction_added
  entityType  String
  entityId    String
  changes     Json?
  userId      String?
  createdAt   DateTime  @default(now())

  @@index([entityType, entityId])
  @@index([createdAt])
}
